{% extends 'shortener_base.html' %}
{% block title %}我的短網址{% endblock %}
{% block content %}
{% if messages %}
    {% for message in messages %}
        {% if 'warning' in message.tags %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endfor %}
{% endif %}
<h3>我的短網址</h3>
<a class="btn btn-secondary btn-sm col-1" href="{% url 'create_short_url' %}">建立新短網址</a>

<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
        <th>短網址</th>
        <th>操作</th>
        <th>原始連結</th>
        <th>點擊次數</th>
        <th>詳細資料</th>
        </tr>
    </thead>
    <tbody>
        {% for url in urls %}
        <tr id="shorturlrow-{{ url.id }}">
        <td><a href="/u/{{ url.slug }}" target="_blank" id="shorturl-{{ forloop.counter }}">{{ url.slug }}</a></td>
        <td>
            <button class="btn btn-sm btn-outline-secondary" onclick="copytoclipboard('shorturl-{{ forloop.counter }}')">
            <i class="bi bi-clipboard"></i> 複製
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteshortUrl('{{ url.id }}')">刪除</button>
        </td>
        <td>{{ url.url | truncatechars:40 }}</td>
        <td>{{ url.total_clicks }}</td>
        <td><a href="{% url 'url_stats' url.slug %}">查看詳細記錄</a></td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-center">目前沒有任何短網址。</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
        <div class="toast-body" id="toastMessage">操作成功</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
<script>
// 等待 DOM 載入
document.addEventListener("DOMContentLoaded", function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
    // 3 秒後自動消失
    setTimeout(() => {
        // 使用 Bootstrap 5 的 Alert API
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
        }, 3000); // 1000ms = 1秒
    });
    });

// 顯示 Bootstrap Toast 的共用函式
function showtoast(message, color="dark") {
    const toastEl = document.getElementById('liveToast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.innerText = message;
    toastEl.className = `toast align-items-center text-bg-${color} border-0`;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    }

// 複製短網址
function copytoclipboard(elementId, event) {
    const el = document.getElementById(elementId);
    const slug = el.innerText.trim();
    const baseUrl = window.location.origin;
    const fullUrl = `${baseUrl}/u/${slug}`;

    navigator.clipboard.writeText(fullUrl).then(() => {
        showtoast(`已複製：${fullUrl}`, "success");
    }).catch(err => {
        console.error("複製失敗：", err);
        showtoast("複製失敗，請手動選取文字。", "danger");
    });
    }

// 刪除短網址（使用 AJAX，不重整）
function deleteshortUrl(urlId) {
    if (!confirm("確定要刪除這個短網址嗎？")) return;

    fetch(`/delete/${urlId}/`, {
        method: "DELETE",
        headers: {
        "X-CSRFToken": getCSRFToken(),
        },
    })
    .then(response => {
        if (response.ok) {
        document.getElementById(`shorturlrow-${urlId}`).remove();
        showtoast("已刪除短網址！", "warning");
        } else {
        showtoast("刪除失敗，請稍後再試。", "danger");
        }
    })
    .catch(() => showtoast("網路錯誤。", "danger"));
    }

// 從 cookie 取 CSRF token
function getCSRFToken() {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith('csrftoken=')) {
        cookieValue = cookie.substring('csrftoken='.length);
        break;
        }
    }
    return cookieValue;
    }
</script>

{% endblock %}
